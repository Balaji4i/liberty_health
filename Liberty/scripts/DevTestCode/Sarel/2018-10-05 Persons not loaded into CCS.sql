SET SERVEROUTPUT ON;
define p_db_link = MEDWARE_PROD.LIBERTY.CO.ZA;

MERGE INTO COMMS_CALC_SNAPSHOT ccsu
USING
(
WITH det AS
(
SELECT PERSON_CODE, CONTRIBUTION_DATE, AMPOUNT, count(*) NO_OF_RECORDS
  FROM
(
SELECT '05097468-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097468-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, -444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, -444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097487-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 444340 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097491-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097513-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097528-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097532-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097547-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, -244894 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097551-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097566-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097607-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097611-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097626-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097645-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097664-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097683-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '05097698-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/APR/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/AUG/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/DEC/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/FEB/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/JAN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/JUL/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/JUN/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/MAR/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/MAY/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/NOV/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/OCT/15', 'DD/MON/YY') CONTRIBUTION_DATE, 140660 AMPOUNT FROM DUAL UNION ALL
SELECT '6068138-00' PERSON_CODE, to_date('01/SEP/15', 'DD/MON/YY') CONTRIBUTION_DATE, -140660 AMPOUNT FROM DUAL
) inner
group by PERSON_CODE, CONTRIBUTION_DATE, AMPOUNT
),
     ccs AS
(
  select to_number(trim(com.ag_code))                    broker_id_no
        ,trim(com.g_group)                               group_code
        ,trim(co_street_country)                         country_code
        ,trim(com.o_option)                              product_code
        ,trim(com.m_member)                              policy_code
        ,trim(mem.m_member) || '-' || trim(mem.b_depend) person_code
        ,sch.s_base_cur                                  base_cur
        ,cur_key
        ,to_date(trim(sa_dt_subs),'yyyy-mm-dd')          contribution_date
        ,to_date(trim(cm_dt_run),'yyyy-mm-dd')           calculation_datetime
        ,round(sum(to_number(trim(cm_conv_amt_excl)))
              /sum(to_number(trim(cm_amt_excl_vat))),9)  exch_rate
        ,sum(to_number(trim(cm_1st_recu_amt)))           comms_perc
        ,case when trim(cm_tran_type)= 'PADJ' then
           (sum(to_number(trim(cm_amt_excl_vat))) * sum(to_number(trim(cm_1st_recu_amt))))
         else 
           sum(to_number(trim(cm_subs_paid*-1)))
         end                                             payment_receive_amt
        ,sum(to_number(trim(cm_conv_amt_excl)))          comms_calculated_exc_amt
        ,sum(to_number(trim(cm_amt_excl_vat)))           comms_calculated_amt
  from   commhist@&&p_db_link com
  left outer
  join   contacts@&&p_db_link con
    on   'SC'||trim(com.s_scheme) = trim(con.k_common_key)
  left outer
  join   scheme@&&p_db_link   sch
    on   trim(sch.s_scheme) = trim(com.s_scheme)
  left outer
  join   member@&&p_db_link mem
    on   com.m_member = mem.m_member
  where (    floor(months_between(sysdate, to_date(trim(cm_dt_run),'yyyy-mm-dd'))) <= 24
         OR  cm_dt_pay = 0)
     and trim(com.s_scheme) in ('IBUG', 'LBLU')     -- LS in ('LHLS')--not in ('BMIR','IMED','ESMA','HERI','CFC')
     and substr(com.s_scheme,0,1) not in ('A','O','U')
     and 0 <> (select sum(to_number(trim(cm_amt_excl_vat))) from commhist@&&p_db_link
                where ag_code = com.ag_code
                  and g_group = com.g_group
                  and o_option = com.o_option
                  and m_member = com.m_member
                  and cur_key = com.cur_key
                  and cm_tran_type = com.cm_tran_type
                  and sa_dt_subs = com.sa_dt_subs
                  and cm_dt_run = com.cm_dt_run)
  group by trim(com.ag_code) 
          ,trim(com.g_group)
          ,trim(co_street_country)
          ,trim(com.o_option)
          ,trim(com.m_member)
          ,trim(mem.m_member) || '-' || trim(mem.b_depend)
          ,sch.s_base_cur
          ,cur_key
          ,trim(cm_tran_type)
          ,to_date(trim(sa_dt_subs),'yyyy-mm-dd')
          ,to_date(trim(cm_dt_run),'yyyy-mm-dd')
)

SELECT comms_calc_snapshot_no,
       sum(payment_receive_amt) payment_receive_amt,
       sum(comms_calculated_amt) comms_calculated_amt,
       sum(comms_calculated_exc_amt) comms_calculated_exc_amt
  FROM
(
SELECT 
        det_person_code
       ,det_contribution_date
       ,det_amount
       ,det_no_of_records
       ,(SELECT max(comms_calc_snapshot_no)
           FROM comms_calc_snapshot
          WHERE     COUNTRY_CODE =                ccsn.COUNTRY_CODE
                AND PRODUCT_CODE =                ccsn.PRODUCT_CODE
                AND PERSON_CODE =                 ccsn.PERSON_CODE
                AND POLICY_CODE =                 ccsn.POLICY_CODE
                AND GROUP_CODE =                  ccsn.GROUP_CODE
                AND BROKER_ID_NO =                ccsn.BROKER_ID_NO
                AND COMPANY_ID_NO =               ccsn.BROKER_ID_NO
                AND CONTRIBUTION_DATE =           ccsn.CONTRIBUTION_DATE
                AND PAYMENT_RECEIVE_DATE =        ccsn.CONTRIBUTION_DATE
                AND FINANCE_RECEIPT_NO =          '0'
                AND CALCULATION_DATETIME <=       ccsn.CALCULATION_DATETIME
                AND COMMS_CALC_TYPE_CODE =        'P'
                AND payment_receive_amt =         ccsn.det_amount
                AND PAYMENT_CURRENCY =            ccsn.BASE_CUR
                AND EXCHANGE_RATE_CURRENCY_CODE = ccsn.CUR_KEY
          GROUP BY PERSON_CODE)
        comms_calc_snapshot_no
       ,broker_id_no
       ,group_code
       ,country_code
       ,product_code
       ,policy_code
       ,person_code
       ,base_cur
       ,cur_key
       ,contribution_date
       ,calculation_datetime
       ,exch_rate
       ,comms_perc
       ,payment_receive_amt
       ,comms_calculated_exc_amt
       ,comms_calculated_amt
  FROM (
SELECT 
        det.PERSON_CODE                   det_person_code
       ,det.CONTRIBUTION_DATE             det_contribution_date
       ,det.AMPOUNT                       det_amount
       ,det.NO_OF_RECORDS                 det_no_of_records
       ,max(ccs.broker_id_no)             broker_id_no
       ,max(ccs.group_code)               group_code
       ,max(ccs.country_code)             country_code
       ,max(ccs.product_code)             product_code
       ,max(ccs.policy_code)              policy_code
       ,max(ccs.person_code)              person_code
       ,max(ccs.base_cur)                 base_cur
       ,max(ccs.cur_key)                  cur_key
       ,max(ccs.contribution_date)        contribution_date
       ,max(ccs.calculation_datetime)     calculation_datetime
       ,max(ccs.exch_rate)                exch_rate
       ,max(ccs.comms_perc)               comms_perc
       ,max(ccs.payment_receive_amt)      
        * det.NO_OF_RECORDS               payment_receive_amt
       ,max(ccs.comms_calculated_exc_amt) 
        * det.NO_OF_RECORDS               comms_calculated_exc_amt
       ,max(ccs.comms_calculated_amt)     
        * det.NO_OF_RECORDS               comms_calculated_amt
  FROM det
  LEFT OUTER
  JOIN ccs
    ON     det.person_code = ccs.person_code
       AND det.contribution_date = ccs.contribution_date
       AND det.ampount = ccs.payment_receive_amt
 GROUP BY det.PERSON_CODE, det.CONTRIBUTION_DATE, det.AMPOUNT, det.NO_OF_RECORDS
 ORDER BY 1, 2, 3, 4
) ccsn
) ccsi
 GROUP BY comms_calc_snapshot_no
) ccslast
ON (ccslast.comms_calc_snapshot_no = ccsu.comms_calc_snapshot_no)

WHEN MATCHED THEN
  UPDATE
    SET last_update_datetime = SYSDATE,
        username = 'MedFix',
        poep_id = 0,
        payment_receive_amt = payment_receive_amt + ccslast.payment_receive_amt,
        comms_calculated_amt = comms_calculated_amt + ccslast.comms_calculated_amt,
        comms_calculated_exch_amt = comms_calculated_exch_amt + ccslast.comms_calculated_exc_amt
 ;